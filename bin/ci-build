#!/bin/sh
#
# CI job entry point
#
# Run the build pipeline on the CI server by first checking the git differences
# on the last commit to check which packages should be (re-)built.
#
# Usage: bin/build-pipeline ab02df..2e0cfa

main() {
  # cd to root path
  cd "$(dirname "$0")/.." || exit;

  packages=$(changed_packages "$1"); status=$?

  if ! [ $status -eq 0 ]; then
    echo "Invalid parameter: $1"
    exit 1
  fi

  if [ -z "$packages" ]; then
    echo "No package changed. Skipping."
    exit
  fi

  # First, fetch the data from S3
  bin/pull-sign-key-from-s3
  bin/pull-repo-from-s3

  # Then, build needed packages
  # shellcheck disable=SC2086
  bin/build $packages

  # And deploy them
  # shellcheck disable=SC2086
  bin/deploy-to-s3 $packages
}

changed_packages() {
  set -eo pipefail
  git show --format="" --name-only "$1" src 2> /dev/null \
    | awk -F '/' '{ print $2 }' | uniq | xargs
}

# shellcheck disable=SC2068
main $@
